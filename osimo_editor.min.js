/*
*	Osimo - next-generation forum system
*	Licensed under GPLv3 (GPL-LICENSE.txt)
*
*	os-includes/js/osimo_editor.js - Javascript for Osimo's BBCode editor
*	The class is included in the standard Osimo header, but
*	is *not* automatically instantiated; the theme developer must do it manually.
*	This is to allow for more flexibilty and more control over it.
*	--------------------------------------------------------------
*	The Osimo BBCode Editor requires jQuery >= 1.3.x. This is already included
*	with Osimo automatically, but if you are using this outside of
*	Osimo you will need to provide jQuery on your own.
*/
(function(d){function h(a,b,c){this.input=a;this.options=b;this.num=c;this.init()}function e(){}d.fn.osimoeditor=function(a,b){d.fn.osimoeditor.$this=d(this);if(typeof a=="string"){if(a=="get")return d.fn.osimoeditor.get(d(this).attr("id"));a=="set"&&d.fn.osimoeditor.set(d(this).attr("id"),b);a=="append"&&d.fn.osimoeditor.append(d(this).attr("id"),b);a=="prepend"&&d.fn.osimoeditor.prepend(d(this).attr("id"),b)}var c=d.extend({},d.fn.osimoeditor.defaultOptions,a),f=0;this.each(function(){if(d(this).is("textarea")){var g=
d(this);new h(g,c,f);f++}})};d.fn.osimoeditor.defaultOptions={editor_path:"js/",theme:"default",width:"500px",height:false,editorHeight:"100px",styles:{},editorStyles:{}};d.fn.osimoeditor.majorVersion="1";d.fn.osimoeditor.minorVersion="0";d.fn.osimoeditor.statusVersion="0";d.fn.osimoeditor.releaseDate="September 15, 2009 @ 11:57pm EDT";d.fn.osimoeditor.get=function(a){return d("#"+a+"_editbox").attr("value")};d.fn.osimoeditor.set=function(a,b){d("#"+a+"_editbox").attr("value",b)};d.fn.osimoeditor.append=
function(a,b){d("#"+a+"_editbox").attr("value",this.get(a)+b)};d.fn.osimoeditor.prepend=function(a,b){d("#"+a+"_editbox").attr("value",b+this.get(a))};h.prototype.init=function(){if(this.options.editor_path.substring(this.options.editor_path.length-1,this.options.editor_path.length)!="/")this.options.editor_path+="/";this.options.theme_path=this.options.editor_path+"themes/"+this.options.theme+"/";this.template="";this.controls=new e;this.injectCSS();this.loadTheme()};h.prototype.injectCSS=function(){d("head").append('<link rel="stylesheet" href="'+
this.options.theme_path+'osimo_editor.css" type="text/css" />')};h.prototype.loadTheme=function(){if(this.template==""&&window.sessionStorage)if(sessionStorage.osimo_bbeditor_theme!=null)this.template=sessionStorage.osimo_bbeditor_theme;if(this.template==""){var a=this;d.ajax({type:"POST",url:a.options.editor_path+"theme_loader.php",data:{theme:this.options.theme},success:function(b){a.template=b;if(window.sessionStorage)sessionStorage.osimo_bbeditor_theme=b;a.buildEditor()}})}else this.buildEditor()};
h.prototype.buildEditor=function(){var a=this.input.attr("value"),b;this.input.attr("id")!=null?(b=this.input.attr("id")):(b="osimo_editor"+num);var c=this,f={id:b+"_editbox",eClass:c.input.attr("class"),style:c.input.attr("style"),name:c.input.attr("name")},g="<textarea ";d.each(f,function(j,i){if(j=="eClass")g+='class="'+i+'" ';else if(i)g+=j+'="'+i+'" '});g+=">"+a+"</textarea>";this.input.replaceWith(d(this.template).attr("id",this.input.attr("id")).clone().appendTo("<div>").parent().html().replace(/\{\*osimo_editor\*\}/,
g));d("#"+f.id).hasClass("osimo-editor-editbox")||d("#"+f.id).addClass("osimo-editor-editbox");if(this.options.width){d("#"+b).css({width:c.options.width});d("#"+f.id).css({width:c.options.width})}this.options.height&&d("#"+b).css({height:c.options.height});this.options.editorHeight&&d("#"+f.id).css({height:c.options.editorHeight});this.options.styles&&d("#"+b).css(c.options.styles);this.options.editorStyles&&d("#"+f.id).css(c.options.editorStyles);this.controls.activate(b)};e.prototype.activate=
function(a){this.input=a;d.each(d("#"+this.input+" .osimo-editor-menu, #"+this.input+" .osimo-editor-button"),function(){var b=d(this).hasClass("osimo-editor-menu")?"change":"click";d(this).bind(b,function(){var c=d(this).attr("class").split(" ")[1].replace(/\-/gi,"_")+"()";c=c.split("osimo_editor_")[1];eval("that."+c+";")})})};e.prototype.getTextSelection=function(){var a=d("#"+this.input+"_editbox").get(0);if(window.getSelection){var b=a.value.length,c=a.selectionStart,f=a.selectionEnd,g=a.value.substring(c,
f);return a={textarea:a,start:c,end:f,len:b,sel:g}}else if(document.selection){b=document.selection.createRange();c=b.duplicate();c.moveToElementText(a);c.setEndPoint("EndToEnd",b);a.selectionStart=c.text.length-b.text.length;a.selectionEnd=a.selectionStart+b.text.length;return a={textarea:a,start:a.selectionStart,end:a.selectionEnd,len:a.value.length,sel:b.text}}};e.prototype.replaceText=function(a){var b="#"+this.input+"_editbox";a=d(b).attr("value").substring(0,a.start)+a.replace+a.textarea.value.substring(a.end,
a.len);d(b).attr("value",a).focus()};e.prototype.simpleReplace=function(a){var b=this.getTextSelection();b.replace="["+a+"]"+b.sel+"[/"+a+"]";this.replaceText(b)};e.prototype.customReplace=function(a,b){var c=this.getTextSelection();c.replace=a+c.sel+b;this.replaceText(c)};e.prototype.conditionReplace=function(a,b){var c=this.getTextSelection();c.sel?a(c):b(c)};e.prototype.text_bold=function(){this.simpleReplace("b")};e.prototype.text_italic=function(){this.simpleReplace("i")};e.prototype.text_underline=
function(){this.simpleReplace("u")};e.prototype.align_left=function(){this.simpleReplace("left")};e.prototype.align_center=function(){this.simpleReplace("center")};e.prototype.align_right=function(){this.simpleReplace("right")};e.prototype.no_code=function(){this.simpleReplace("nocode")};e.prototype.bullet_list=function(){this.customReplace("[list]\n[*]","\n[/list]")};e.prototype.font_family=function(){var a=d("#"+this.input+" .osimo-editor-font-family").attr("value");a!=""&&this.customReplace("[font="+
a+"]","[/font]")};e.prototype.font_size=function(){var a=d("#"+this.input+" .osimo-editor-font-size").attr("value");a!=""&&this.customReplace("[size="+a+"]","[/size]")};e.prototype.font_color=function(){var a=d("#"+this.input+" .osimo-editor-font-color").attr("value");a==""||!a||this.customReplace("[color="+a+"]","[/color]")};e.prototype.quote_user=function(){var a=prompt("Enter the username of the person you are quoting (optional).","");if(a!=null)a==""?this.simpleReplace("quote"):this.customReplace("[quote="+
a+"]","[/quote]")};e.prototype.image_add=function(){var a=this;this.conditionReplace(function(b){b.replace="[img]"+b.sel+"[/img]";a.replaceText(b)},function(b){var c=prompt("Enter the URL to the image.","http://");if(!(c==null||c=="")){b.replace="[img]"+c+"[/img]";a.replaceText(b)}})};e.prototype.link_add=function(){var a=this;this.conditionReplace(function(b){var c=prompt("Enter the URL you wish to link to.","http://");if(!(c==null||c=="")){b.replace="[url="+c+"]"+b.sel+"[/url]";a.replaceText(b)}},
function(b){var c=prompt("Enter the URL you wish to link to.","http://");if(!(c==null||c=="")){var f=prompt("Enter the text you want to turn into a link (optional).","");if(f!=null){b.replace=f==""?"[url]"+c+"[/url]":"[url="+c+"]"+f+"[/url]";a.replaceText(b)}}})};e.prototype.email_add=function(){var a=this;this.conditionReplace(function(b){var c=prompt("Enter the email address you wish to link to.","");if(!(c==null||c=="")){b.replace="[email="+c+"]"+b.sel+"[/email]";a.replaceText(b)}},function(b){var c=
prompt("Enter the email address you wish to link to.","");if(!(c==null||c=="")){var f=prompt("Enter the text you want to turn into a link (optional).","");if(f!=null){b.replace=f==""?"[email]"+c+"[/email]":"[email="+c+"]"+f+"[/email]";a.replaceText(b)}}})}})(jQuery);